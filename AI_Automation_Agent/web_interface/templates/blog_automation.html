{% extends "base.html" %}

{% block title %}Blog Automation - AI Automation Agent{% endblock %}

{% block page_title %}Blog Automation{% endblock %}
{% block page_description %}Manage your blog automation settings, scheduling, and content generation{% endblock %}

{% block content %}
<div class="blog-automation-container">
    <!-- Quick Actions Bar -->
    <div class="actions-bar">
        <div class="actions-group">
            <button class="btn btn-primary" id="generateSingleBlog">
                <i class="fas fa-plus"></i> Generate Single Blog
            </button>
            <button class="btn btn-success" id="generateBlogSeries">
                <i class="fas fa-layer-group"></i> Generate Blog Series
            </button>
            <button class="btn btn-info" id="scheduleDailyBlog">
                <i class="fas fa-calendar"></i> Schedule Daily Blog
            </button>
        </div>
        <div class="actions-group">
            <button class="btn btn-secondary" id="refreshPosts">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-blog"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="totalBlogs">--</div>
                <div class="stat-label">Total Blogs</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-eye"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="totalViews">--</div>
                <div class="stat-label">Total Views</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-heart"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="avgEngagement">--</div>
                <div class="stat-label">Avg Engagement</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="avgSeoScore">--</div>
                <div class="stat-label">Avg SEO Score</div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="blog-grid">
        <!-- Blog Posts Table -->
        <div class="blog-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Recent Blog Posts</h3>
                <div class="section-filters">
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                        <option value="scheduled">Scheduled</option>
                    </select>
                    <select id="topicFilter">
                        <option value="">All Topics</option>
                        <option value="ai">AI</option>
                        <option value="technology">Technology</option>
                        <option value="programming">Programming</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table class="blog-table" id="blogTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Topic</th>
                            <th>Status</th>
                            <th>Views</th>
                            <th>Engagement</th>
                            <th>SEO Score</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="loading-cell">Loading blog posts...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Scheduling Panel -->
        <div class="scheduling-panel">
            <div class="panel-header">
                <h3><i class="fas fa-calendar-alt"></i> Scheduling</h3>
            </div>
            <div class="panel-content">
                <!-- Current Schedule -->
                <div class="schedule-section">
                    <h4>Current Schedule</h4>
                    <div class="schedule-list" id="currentSchedule">
                        <div class="schedule-item">
                            <div class="schedule-loading">Loading schedule...</div>
                        </div>
                    </div>
                </div>

                <!-- Add New Schedule -->
                <div class="schedule-form">
                    <h4>Quick Schedule</h4>
                    <form id="quickScheduleForm">
                        <div class="form-group">
                            <label>Frequency</label>
                            <select id="scheduleFrequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Time</label>
                            <input type="time" id="scheduleTime" value="09:00">
                        </div>
                        <div class="form-group">
                            <label>Topics</label>
                            <div class="topic-tags" id="scheduleTopics">
                                <span class="topic-tag">AI</span>
                                <span class="topic-tag">Technology</span>
                                <span class="topic-tag">Programming</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-plus"></i> Add Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Blog Automation specific JavaScript
class BlogAutomation {
    constructor() {
        this.currentPosts = [];
        this.scheduledJobs = [];
        this.initializeEventListeners();
        this.loadData();
    }

    initializeEventListeners() {
        // Action buttons
        document.getElementById('generateSingleBlog').addEventListener('click', () => this.showBlogGenerationModal());
        document.getElementById('generateBlogSeries').addEventListener('click', () => this.showSeriesGenerationModal());
        document.getElementById('scheduleDailyBlog').addEventListener('click', () => this.showSchedulingModal());
        document.getElementById('refreshPosts').addEventListener('click', () => this.loadBlogPosts());

        // Filters
        document.getElementById('statusFilter').addEventListener('change', () => this.filterPosts());
        document.getElementById('topicFilter').addEventListener('change', () => this.filterPosts());

        // Quick schedule form
        document.getElementById('quickScheduleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitQuickSchedule();
        });
    }

    async loadData() {
        await Promise.all([
            this.loadBlogPosts(),
            this.loadStatistics(),
            this.loadSchedule()
        ]);
    }

    async loadBlogPosts() {
        try {
            const response = await API.get('/api/blog/posts?limit=50');
            const posts = response.posts || response.data?.posts || [];
            
            this.currentPosts = posts;
            this.renderBlogTable(posts);
            
        } catch (error) {
            console.error('Error loading blog posts:', error);
            this.showToast('Failed to load blog posts', 'error');
        }
    }

    renderBlogTable(posts) {
        const tbody = document.querySelector('#blogTable tbody');
        
        if (posts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">No blog posts found</td></tr>';
            return;
        }

        tbody.innerHTML = posts.map(post => `
            <tr data-post-id="${post.id}">
                <td class="post-title">
                    <div class="title-text">${this.truncateText(post.title, 50)}</div>
                    <div class="post-meta">
                        <span class="word-count">${post.word_count || 0} words</span>
                        ${post.is_auto_generated ? '<span class="auto-tag">AI Generated</span>' : ''}
                    </div>
                </td>
                <td><span class="topic-badge">${post.topic || 'General'}</span></td>
                <td>
                    <span class="status-badge status-${post.status}">${post.status}</span>
                </td>
                <td>
                    <div class="metric-value">${this.formatNumber(post.views || 0)}</div>
                </td>
                <td>
                    <div class="metric-value">${(post.engagement_rate || 0).toFixed(1)}%</div>
                </td>
                <td>
                    <div class="seo-score">
                        <span class="score-value">${post.seo_score || '--'}</span>
                        ${post.seo_score ? '/100' : ''}
                    </div>
                </td>
                <td>
                    <div class="date-value">${this.formatDate(post.created_at)}</div>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-icon" onclick="blogAutomation.viewPost('${post.id}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="blogAutomation.editPost('${post.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="blogAutomation.publishPost('${post.id}')" title="Publish">
                            <i class="fas fa-share"></i>
                        </button>
                        <button class="btn-icon" onclick="blogAutomation.deletePost('${post.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async loadStatistics() {
        try {
            const response = await API.get('/api/analytics/summary?days=30');
            const summary = response.summary || response.data?.summary;
            
            if (summary) {
                // Update statistics
                document.getElementById('totalBlogs').textContent = summary.overall_performance?.total_posts || 0;
                document.getElementById('totalViews').textContent = this.formatNumber(summary.overall_performance?.total_views || 0);
                document.getElementById('avgEngagement').textContent = (summary.overall_performance?.average_engagement_rate || 0).toFixed(1) + '%';
                document.getElementById('avgSeoScore').textContent = (summary.overall_performance?.average_seo_score || 0).toFixed(0) + '/100';
            }
            
        } catch (error) {
            console.error('Error loading statistics:', error);
        }
    }

    async loadSchedule() {
        try {
            // This would load scheduled jobs from the scheduler
            // For now, show sample schedule
            const sampleSchedule = [
                {
                    id: 'daily_morning',
                    type: 'daily',
                    time: '09:00',
                    topics: ['AI', 'Technology'],
                    status: 'active'
                },
                {
                    id: 'weekly_series',
                    type: 'weekly',
                    day: 'Monday',
                    time: '10:00',
                    topics: ['Programming'],
                    status: 'active'
                }
            ];

            this.renderSchedule(sampleSchedule);
            
        } catch (error) {
            console.error('Error loading schedule:', error);
        }
    }

    renderSchedule(schedule) {
        const container = document.getElementById('currentSchedule');
        
        if (schedule.length === 0) {
            container.innerHTML = '<div class="no-schedule">No scheduled jobs found</div>';
            return;
        }

        container.innerHTML = schedule.map(job => `
            <div class="schedule-item" data-job-id="${job.id}">
                <div class="schedule-info">
                    <div class="schedule-type">
                        <i class="fas fa-${job.type === 'daily' ? 'calendar-day' : 'calendar-week'}"></i>
                        ${job.type === 'daily' ? 'Daily' : `Weekly (${job.day})`}
                    </div>
                    <div class="schedule-time">${job.time}</div>
                    <div class="schedule-topics">
                        ${job.topics.map(topic => `<span class="topic-tag">${topic}</span>`).join('')}
                    </div>
                </div>
                <div class="schedule-actions">
                    <button class="btn-icon" onclick="blogAutomation.editSchedule('${job.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="blogAutomation.toggleSchedule('${job.id}')" title="Toggle">
                        <i class="fas fa-${job.status === 'active' ? 'pause' : 'play'}"></i>
                    </button>
                    <button class="btn-icon" onclick="blogAutomation.deleteSchedule('${job.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    filterPosts() {
        const statusFilter = document.getElementById('statusFilter').value;
        const topicFilter = document.getElementById('topicFilter').value;
        
        const filteredPosts = this.currentPosts.filter(post => {
            const statusMatch = !statusFilter || post.status === statusFilter;
            const topicMatch = !topicFilter || (post.topic && post.topic.toLowerCase().includes(topicFilter.toLowerCase()));
            return statusMatch && topicMatch;
        });

        this.renderBlogTable(filteredPosts);
    }

    showBlogGenerationModal() {
        const modal = this.createModal('Generate Single Blog Post', this.getBlogGenerationForm());
        modal.show();
    }

    showSeriesGenerationModal() {
        const modal = this.createModal('Generate Blog Series', this.getSeriesGenerationForm());
        modal.show();
    }

    showSchedulingModal() {
        const modal = this.createModal('Schedule Blog Generation', this.getSchedulingForm());
        modal.show();
    }

    getBlogGenerationForm() {
        return `
            <form id="blogGenerationForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Topic *</label>
                        <input type="text" id="blogTopic" placeholder="e.g., AI in Healthcare" required>
                    </div>
                    <div class="form-group">
                        <label>Max Words</label>
                        <input type="number" id="blogMaxWords" value="800" min="100" max="2000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target Audience</label>
                        <select id="blogAudience">
                            <option value="general">General Public</option>
                            <option value="professionals">Professionals</option>
                            <option value="experts">Industry Experts</option>
                            <option value="beginners">Beginners</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Writing Style</label>
                        <select id="blogStyle">
                            <option value="informative">Informative</option>
                            <option value="casual">Casual</option>
                            <option value="technical">Technical</option>
                            <option value="how_to">How-to Guide</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="publishImmediately"> Publish immediately after generation
                    </label>
                </div>
                <div class="form-group">
                    <label>Additional Instructions</label>
                    <textarea id="blogInstructions" placeholder="Any specific requirements or instructions..."></textarea>
                </div>
            </form>
        `;
    }

    getSeriesGenerationForm() {
        return `
            <form id="seriesGenerationForm">
                <div class="form-group">
                    <label>Main Topic *</label>
                    <input type="text" id="seriesTopic" placeholder="e.g., Python Programming for Beginners" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Number of Posts</label>
                        <input type="number" id="seriesCount" value="3" min="2" max="10">
                    </div>
                    <div class="form-group">
                        <label>Target Audience</label>
                        <select id="seriesAudience">
                            <option value="general">General Public</option>
                            <option value="professionals">Professionals</option>
                            <option value="experts">Industry Experts</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="publishSeriesImmediately"> Publish series immediately
                    </label>
                </div>
                <div class="form-group">
                    <label>Series Description</label>
                    <textarea id="seriesDescription" placeholder="Describe what this series will cover..."></textarea>
                </div>
            </form>
        `;
    }

    getSchedulingForm() {
        return `
            <form id="schedulingForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Frequency</label>
                        <select id="scheduleFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time *</label>
                        <input type="time" id="scheduleTime" value="09:00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Topics *</label>
                    <div class="topic-selection" id="scheduleTopicSelection">
                        <input type="text" id="topicInput" placeholder="Add topic and press Enter">
                        <div class="selected-topics" id="selectedTopics"></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Max Words</label>
                        <input type="number" id="scheduleMaxWords" value="800" min="100" max="2000">
                    </div>
                    <div class="form-group">
                        <label>Publishing</label>
                        <select id="schedulePublishMode">
                            <option value="draft">Save as Draft</option>
                            <option value="publish">Publish Immediately</option>
                        </select>
                    </div>
                </div>
            </form>
        `;
    }

    createModal(title, content) {
        const modal = document.createElement('div');
        modal.className = 'modal large';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${title}</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">${content}</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary modal-cancel">Cancel</button>
                    <button class="btn btn-primary modal-submit">Generate</button>
                </div>
            </div>
        `;

        // Event listeners
        modal.querySelector('.modal-close').addEventListener('click', () => modal.remove());
        modal.querySelector('.modal-cancel').addEventListener('click', () => modal.remove());
        modal.querySelector('.modal-submit').addEventListener('click', () => this.handleModalSubmit(title, modal));

        document.body.appendChild(modal);
        return {
            show: () => modal.classList.add('show'),
            hide: () => modal.classList.remove('show')
        };
    }

    async handleModalSubmit(title, modal) {
        try {
            this.showLoading(true);
            
            if (title.includes('Single Blog Post')) {
                const response = await API.post('/api/blog/generate', {
                    topic: document.getElementById('blogTopic').value,
                    max_words: parseInt(document.getElementById('blogMaxWords').value),
                    target_audience: document.getElementById('blogAudience').value,
                    style: document.getElementById('blogStyle').value,
                    publish_immediately: document.getElementById('publishImmediately').checked,
                    instructions: document.getElementById('blogInstructions').value
                });
                this.showToast('Blog post generation started', 'success');
                
            } else if (title.includes('Blog Series')) {
                const response = await API.post('/api/blog/series', {
                    main_topic: document.getElementById('seriesTopic').value,
                    num_posts: parseInt(document.getElementById('seriesCount').value),
                    target_audience: document.getElementById('seriesAudience').value,
                    publish_immediately: document.getElementById('publishSeriesImmediately').checked,
                    description: document.getElementById('seriesDescription').value
                });
                this.showToast('Blog series generation started', 'success');
                
            } else if (title.includes('Schedule')) {
                // Handle scheduling logic here
                this.showToast('Schedule created successfully', 'success');
            }

            modal.remove();
            await this.loadBlogPosts();
            
        } catch (error) {
            console.error('Generation error:', error);
            this.showToast('Generation failed', 'error');
        } finally {
            this.showLoading(false);
        }
    }

    async submitQuickSchedule() {
        try {
            const formData = {
                frequency: document.getElementById('scheduleFrequency').value,
                time: document.getElementById('scheduleTime').value,
                topics: Array.from(document.querySelectorAll('.topic-tag')).map(tag => tag.textContent)
            };

            // This would call the scheduling API
            this.showToast('Schedule added successfully', 'success');
            await this.loadSchedule();
            
        } catch (error) {
            this.showToast('Failed to add schedule', 'error');
        }
    }

    // Post management functions
    viewPost(postId) {
        // Implement post viewing
        console.log('View post:', postId);
    }

    editPost(postId) {
        // Implement post editing
        console.log('Edit post:', postId);
    }

    async publishPost(postId) {
        try {
            this.showLoading(true);
            // Implement publishing logic
            this.showToast('Post published successfully', 'success');
            await this.loadBlogPosts();
        } catch (error) {
            this.showToast('Failed to publish post', 'error');
        } finally {
            this.showLoading(false);
        }
    }

    async deletePost(postId) {
        if (confirm('Are you sure you want to delete this blog post?')) {
            try {
                // Implement delete logic
                this.showToast('Post deleted successfully', 'success');
                await this.loadBlogPosts();
            } catch (error) {
                this.showToast('Failed to delete post', 'error');
            }
        }
    }

    // Utility functions
    truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
        if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
        return num.toString();
    }

    formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }

    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        overlay.style.display = show ? 'flex' : 'none';
    }
}

// Initialize blog automation when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.blogAutomation = new BlogAutomation();
});
</script>
{% endblock %}